<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="HandheldFriendly" content="true">
  <script type="text/javascript" src="js/svg.min.js" charset="utf-8"></script>
  <script src="js/svg.connectable.js"></script>
  <style type="text/css">
  .main {
    text-align: center;
    padding: 20;
  }

  #testEl {
    color: red;
    font-family: 'astro';
    background-color: #eee;
  }
  .red{
    color: red;
  }

  @font-face {
    font-family: 'astro';
    src:url('font/astro.woff') format('woff');
    /* Legacy iOS */
    font-weight: normal;
    font-style: normal;
  }
  .starFont {
    font-family: 'astro'
  }
  </style>
</head>

<body>
  <div id="testEl">asdfasdf</div>
  <div id="testSVG"></div>
  <div id="main" class="main">
    <div id="astro"></div>
  </div>
  <script>
  var planetsData = {
    'sun': {
      'name': 'sun',
      'lon': 316.81797600093626,
      'lat': 0.0004108106661321218,
      'spd': 1.0098260642621426,
      'r': 0
    },
    'moon': {
      'name': 'moon',
      'lon': 326.0242175662381,
      'lat': -1.2666176621572691,
      'spd': 11.784215357124594,
      'r': 0
    },
    'mercury': {
      'name': 'mercury',
      'lon': 334.2201905101414,
      'lat': 1.3454868374151474,
      'spd': 0.48104779438062906,
      'r': 0
    },
    'venus': {
      'name': 'venus',
      'lon': 301.8172830238122,
      'lat': -0.633749811484642,
      'spd': 1.2511515060964484,
      'r': 0
    },
    'mars': {
      'name': 'mars',
      'lon': 329.01665019172503,
      'lat': -1.0414450814576528,
      'spd': 0.7880249228264802,
      'r': 0
    },
    'jupiter': {
      'name': 'jupiter',
      'lon': 190.16361397054163,
      'lat': 1.4654571685733873,
      'spd': -0.03487566175408574,
      'r': 0
    },
    'saturn': {
      'name': 'saturn',
      'lon': 189.4960389523151,
      'lat': 2.5208657429238936,
      'spd': -0.029923668733999875,
      'r': 0
    },
    'uranus': {
      'name': 'uranus',
      'lon': 239.77387282404084,
      'lat': 0.22525176978027348,
      'spd': 0.024867982375553765,
      'r': 0
    },
    'neptune': {
      'name': 'neptune',
      'lon': 264.1927105872144,
      'lat': 1.3089504736466098,
      'spd': 0.02563382736298081,
      'r': 0
    },
    'pluto': {
      'name': 'pluto',
      'lon': 204.31516118590744,
      'lat': 17.343013961732847,
      'spd': -0.005452316997889284,
      'r': 0
    },
    'mean_node': {
      'name': 'mean_node',
      'lon': 130.62312516773838,
      'lat': 0,
      'spd': -0.05296177377545064,
      'r': 0
    },
    'chiron': {
      'name': 'chiron',
      'lon': 43.5052345101053,
      'lat': -2.11740419283264,
      'spd': 0.013930854869670384,
      'r': 0
    },
    'pholus': {
      'name': 'pholus',
      'lon': 359.2381717864676,
      'lat': -21.31818577049128,
      'spd': 0.056111419439730525,
      'r': 0
    },
    'ceres': {
      'name': 'ceres',
      'lon': 105.24143734697998,
      'lat': 9.622921376999386,
      'spd': -0.1523610105635953,
      'r': 0
    },
    'pallas': {
      'name': 'pallas',
      'lon': 28.182609745094318,
      'lat': -30.62175266741695,
      'spd': 0.37003767719312464,
      'r': 0
    },
    'juno': {
      'name': 'juno',
      'lon': 216.89360101511954,
      'lat': 6.977622611331037,
      'spd': 0.10345614541051873,
      'r': 0
    },
    'vesta': {
      'name': 'vesta',
      'lon': 157.20224800433607,
      'lat': 8.371002154803717,
      'spd': -0.20587487782108838,
      'r': 0
    },
    'cupido': {
      'name': 'cupido',
      'lon': 218.1866086023104,
      'lat': 1.077466224606196,
      'spd': 0.0007074584118527127,
      'r': 0
    },
    'chariklo': {
      'name': 'chariklo',
      'lon': 34.98530189104559,
      'lat': 22.96795814372611,
      'spd': 0.024017344628646242,
      'r': 0
    },
    'chaos': {
      'name': 'chaos',
      'lon': 32.45982525521509,
      'lat': -3.3494148329201727,
      'spd': 0.00839405903008128,
      'r': 0
    },
    'eris': {
      'name': 'eris',
      'lon': 14.207630934323765,
      'lat': -18.973085727365532,
      'spd': 0.005986353714959591,
      'r': 0
    },
    'nessus': {
      'name': 'nessus',
      'lon': 110.99714757927057,
      'lat': 16.279877634271934,
      'spd': -0.041067750800038993,
      'r': 0
    }
  };
  var planetsFont = [
    'M',
    'N',
    'O',
    'P',
    'Q',
    'R',
    'S',
    'T',
    'U',
    'V',
    'W'
  ];

  var planets = [
    'sun',
    'moon',
    'mercury',
    'venus',
    'mars',
    'jupiter',
    'saturn',
    'uranus',
    'neptune',
    'pluto',
    'mean_node'
    // 'chiron',
    // 'pholus',
    // 'ceres',
    // 'pallas',
    // 'juno',
    // 'vesta',
    // 'cupido',
    // 'chariklo',
    // 'chaos',
    // 'eris',
    // 'nessus'
  ];

  var houseArr = [352.0564146335398,
    35.04129140503142,
    63.44271090260005,
    85.69597507922174,
    107.25433306655145,
    133.180868936381,
    172.05641463353982,
    215.04129140503142,
    243.44271090260006,
    265.69597507922174,
    287.25433306655145,
    313.180868936381
  ];
  var asc = houseArr[0];
  var mc = houseArr[9];
  // astroShow(draw,planetsData, houseArr, asc, mc);
  houseArr = [225.38677571201202,
    254.9245449275749,
    288.9354258928624,
    324.74309363455245,
    357.1118108559691,
    23.675867760700157,
    45.386775712012025,
    74.92454492757491,
    108.93542589286238,
    144.74309363455245,
    177.11181085596914,
    203.67586776070019
  ];
  asc = houseArr[0];
  mc = houseArr[9];



  var pointRotate = function(centerX, centerY, orgX, orgY, rotateAngle) {
    var x = orgX - centerX;
    var y = orgY - centerY;
    var l = (rotateAngle * Math.PI) / 180;
    var x1 = Math.cos(l) * x - Math.sin(l) * y;
    var y1 = Math.cos(l) * y + Math.sin(l) * x;
    return [x1 + centerX, y1 + centerY];
  };

  var pointRotateZeroCenter = function(orgX, orgY, rotateAngle) {
    var l = (rotateAngle * Math.PI) / 180;
    var x1 = Math.cos(l) * orgX - Math.sin(l) * orgY;
    var y1 = Math.cos(l) * orgY + Math.sin(l) * orgX;
    return [x1, y1];
  };

  /**
   * 将点对象集合分散到一个圆上,根据dot.data(dotCircleName).lon进行角度旋转
   * @param  {string} dotCircleName 点名称,用于获取dot中的data
   * @param  {int} centerX    圆中心坐标X
   * @param  {int} centerY    圆中心坐标Y
   * @param  {array} dotArr     dot对象数组
   * @param  {int} radius     圆半径
   * @param  {int} ascAngle   asc线即水平线的角度,用于修正整个圆到水平
   * @return {array}            dot array
   */
  var dotCircleCreate = function(dotCircleName, centerX, centerY, dotArr, radius, ascAngle) {
    // var groupDots = draw.group();
    var dotCircleArr = [];
    var fixAngle = ascAngle || 0;
    // rotate dots
    for (var i = 0; i < planets.length; i++) {
      var dotOne = dotArr[i];
      var pData = dotOne.data(dotCircleName);
      var newPosi = pointRotate(centerX, centerY, centerX - radius, centerY, 0 - pData.lon + fixAngle);
      dotOne.center(newPosi[0], newPosi[1]);
      dotCircleArr.push(dotOne);
    }
    return dotCircleArr;
  };

  var dotArrCreate = function(dotCircleName, dotOne, dotNameArr, dotData) {
    var dotArr = [];
    dotOne.data(dotCircleName, dotData[dotNameArr[0]]);
    dotArr.push(dotOne);

    for (var i = 1; i < planets.length; i++) {
      dotArr.push(dotOne.clone().data(dotCircleName, dotData[dotNameArr[i]]));
    }
    return dotArr;
  };

  var planetsCircle = function(draw, centerX, centerY, planets, planetsData, radius, ascAngle) {


    var circle = draw.circle(radius * 2).fill('#ccc').stroke({
      width: 1,
      color: '#000'
    }).center(centerX, centerY);
    // groupPlanets.add(circle);

    // create planet dots
    var dotRadius = 4;
    var dot = draw.circle(dotRadius * 2).fill('#e4e');
    var dotArr = dotArrCreate('planet', dot, planets, planetsData);
    // rotate dots
    var dotPlanetsArr = dotCircleCreate('planet', centerX, centerY, dotArr, radius, ascAngle);

    //center cross
    var crossLen = 10;
    var line1 = draw.line(0, 0, crossLen, 0).stroke({
      width: 0.5
    }).center(centerX, centerY);
    var line2 = draw.line(0, 0, 0, crossLen).stroke({
      width: 0.5
    }).center(centerX, centerY);
    return dotPlanetsArr;
  };

  var txtCircle = function(draw, centerX, centerY, radius, ascAngle) {


    var textPlanets = [];
    var dotCircleName = 'txtPlanets';
    for (var i = 0; i < planets.length; i++) {
      var pName = planets[i];
      var txtOne = draw.text(planetsFont[i]).font({
        'size': 20,
        'font-family':'astro'
      }).fill('red').data(dotCircleName, planetsData[pName]);
      textPlanets.push(txtOne);
    }
    var txtPlanetArr = dotCircleCreate(dotCircleName, centerX, centerY, textPlanets, radius, ascAngle);
    return txtPlanetArr;
  };


  function test() {
    var draw1 = SVG('testSVG').size('100%', '100%').viewbox(0, 0, 500, 500);
    // var dot = draw1.defs().circle(4).fill('blue').dmove(-2, -2);
    // var centerPoint = draw1.use(dot).move(100, 100);
    // var p1 = draw1.use(dot).move(200, 100);

    // var ro = 0 - planetsData.sun.lon;
    // var g1 = draw1.group();
    // var newPo = pointRotate(100, 100, 200, 100, ro);
    // var p2 = draw1.use(dot).move(newPo[0], newPo[1]);
    // var line = draw1.line(0, 100, 200, 100).stroke('#000');
    // var lineAsc = draw1.line(0, 100, 200, 100).stroke('red');
    // line.rotate(ro);
    // lineAsc.rotate(0 - houseArr[0]);
    // g1.add(lineAsc).add(line).add(p2);
    // g1.rotate(houseArr[0] - 180);
    // var dot2 = draw1.circle(10).fill('blue').move(20, 20);
    // dot2.attr('fill', 'red');


    // 行星点圆
    var pDotArr = planetsCircle(draw1, 250, 250, planets, planetsData, 150, asc);
    // 行星文字圆
    var pTxtArr = txtCircle(draw1, 250, 250, 180, asc);

    var linkerArr = [];
    for (var i = 0; i < pDotArr.length; i++) {
      var bbox1 = pDotArr[i].bbox();
      var bbox2 = pTxtArr[i].bbox();
      var cx1 = bbox1.cx;
      var cy1 = bbox1.cy;
      var cx2 = bbox2.cx;
      var cy2 = bbox2.cy;
      linkerArr.push(draw1.line(cx1, cy1, cx2, cy2).stroke('#ccc').back());
    }


    for (var i = 1; i < pTxtArr.length; i++) {


      console.log(Math.abs(pTxtArr[i].bbox().cy - pTxtArr[i - 1].bbox().cy));
    }
  }
  test();






  var planets = [
    'sun',
    'moon',
    'mercury',
    'venus',
    'mars',
    'jupiter',
    'saturn',
    'uranus',
    'neptune',
    'pluto',
    'mean_node'
    // 'chiron',
    // 'pholus',
    // 'ceres',
    // 'pallas',
    // 'juno',
    // 'vesta',
    // 'cupido',
    // 'chariklo',
    // 'chaos',
    // 'eris',
    // 'nessus'
  ];



  function astroShow(draw, planetsData, houseArr, asc, mc) {
    draw.clear();
    var maxSize = 500;
    var circleDiameter = 480;
    var padding = 10;
    draw.size('100%', '100%').viewbox(0, 0, maxSize, maxSize);
    // var bgColor = new SVG.Color('rgb(250, 253, 185 )');
    var bgColor = new SVG.Color('rgb(248,194,136)');
    var strokeColor = new SVG.Color('rgb(145,84,40)');
    var strokeColorBlue = new SVG.Color('rgb(34,108,162)');
    // var bgColorBlue = new SVG.Color('rgb(234,255,255)');
    var bgColorBlue = new SVG.Color('rgb(250,253,185)');
    var strokeWidth1 = 0.5;
    var strokeWidth2 = 1;
    var strokeStyleOuter = {
      width: 1.5,
      color: strokeColor
    };
    var strokeStyleInner = {
      width: strokeWidth1,
      color: strokeColorBlue
    };
    var strokeStyleInner2 = {
      width: strokeWidth2,
      color: strokeColorBlue
    };
    //Ecliptic circles
    var groupAll = draw.group();
    var groupEcliptic = draw.group();
    var groupHouse = draw.group();
    var circle1 = draw.circle(circleDiameter).fill(bgColor).stroke(strokeStyleOuter);
    var circle2 = draw.circle(circleDiameter - 80).fill(bgColorBlue).dmove(40, 40).stroke(strokeStyleOuter);


    //Ecliptic lines
    var lineEcliptic = draw.defs().line(0, 0, 0, circleDiameter).stroke(strokeStyleOuter);
    var lineEclipticGroup = draw.group();
    // for (var i = 0; i < 12; i++) {
    //   var lineEclipticOne = lineEcliptic.clone().x(circleDiameter / 2).rotate(i * 30);
    //   lineEclipticGroup.add(lineEclipticOne);
    // }
    for (var i = 0; i < 12; i++) {
      var lineEclipticOne = draw.use(lineEcliptic).x(circleDiameter / 2).rotate(i * 30);
      lineEclipticGroup.add(lineEclipticOne);
    }

    //Ecliptic groupEcliptic
    groupEcliptic.add(circle1).add(lineEclipticGroup).add(circle2);

    //house
    var circle3 = draw.circle(circleDiameter - 120).fill('#FFF').dmove(60, 60).stroke(strokeStyleInner2);
    var circle4 = circle3.clone().size(circleDiameter - 200);
    //House lines
    var lineHouse = draw.defs().line(0, 0, circleDiameter - 80, 0).stroke(strokeStyleInner2);
    var lineHouseGroup = draw.group();

    // for (var j = 0; j < 1; j++) {
    for (var j = 0; j < houseArr.length; j++) {
      var lineHouseOne = draw.use(lineHouse).move(40, circleDiameter / 2).rotate(0 - houseArr[j]);
      // var lineHouseOne = draw.use(lineHouse).y(circleDiameter / 2).rotate(20);
      lineHouseGroup.add(lineHouseOne);
    }
    var circleCenter = lineHouseGroup.clone().maskWith(circle3.clone().fill('#222').attr({
      stroke: null
    }));

    // planets star position
    var lineStar = draw.defs().line(0, 0, circleDiameter - 200, 0).stroke({
      color: '#ccc',
      opacity: 0
    });
    var lineStarGroup = draw.group();
    for (var k = 0; k < planets.length; k++) {
      var starLine = lineStar.clone();
      var starObj = planetsData[planets[k]];
      var rotateAngle = starObj.lon;
      var textStar = draw.text(starObj.name).font({
        size: 10
      }).center(50, 50);
      var starMarker = draw.marker(100, 100, function(add) {
        add.add(textStar);
      });
      starLine.marker('start', starMarker);
      starLine.move(100, circleDiameter / 2).rotate(0 - rotateAngle);

      lineStarGroup.add(starLine);
      // textStar.rotate(rotateAngle - asc);
    }
    groupHouse.add(lineHouseGroup).add(circle3).add(circle4).add(circleCenter).add(lineStarGroup);
    // groupHouse.rotate(-asc);
    //
    var lineAsc = draw.line(0 - padding * 2, 0, maxSize, 0).stroke(strokeStyleInner).y(circleDiameter / 2);
    var lineMc = draw.line(0 - padding * 2, 0, maxSize, 0).stroke(strokeStyleInner2).y(circleDiameter / 2);
    lineAsc.rotate(0 - asc);
    lineMc.rotate(0 - mc);
    lineMc.marker('mid', 0, 0, function(add) {
      add.circle(100).fill('#000');
    });
    groupHouse.add(lineAsc).add(lineMc);
    groupHouse.rotate(asc);
    groupEcliptic.rotate(asc);

    // stars
    var starDef = draw.defs().circle(10).fill('#000');
    var starOne = starDef.clone().dmove(0, 0);


    groupAll.add(groupEcliptic).add(groupHouse);
    groupAll.move(padding, padding);

  }

  function startAstro(target) {
    if (!SVG.supported) {
      alert('SVG not supported');
      return false;
    }
    var draw = SVG(target);


    astroShow(draw, planetsData, houseArr, asc, mc);
  }
  startAstro('astro');
  </script>
</body>

</html>
